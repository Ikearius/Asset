(self.webpackChunkmp_webgl=self.webpackChunkmp_webgl||[]).push([[464],{13469:(t,e,i)=>{"use strict";i.d(e,{Ko:()=>m,up:()=>g,hJ:()=>p});var a=i(2212),s=i(7170),n=i(51058),r=i(27687),o=i(48711);const h=new a.Vector2,c=new a.Vector3,d=new a.Vector2,l=new a.Vector2,m=(t,e,i)=>{const a=((t,e,i)=>((0,r.q9)(i,t,d),(0,r.q9)(i,e,l),{pixelDistance:d.distanceTo(l),startScreenPosition:d,endScreenPosition:l}))(t,e,i);return{screenPosition:((t,e,i)=>(c.copy(t).add(e).multiplyScalar(.5),(0,r.q9)(i,c,h),h))(t,e,i),rotation:u(d,l),pixelDistance:a.pixelDistance,startScreenPosition:a.startScreenPosition,endScreenPosition:a.endScreenPosition}},u=(t,e)=>{const i=t.y-e.y,a=t.x-e.x;let n=Math.atan2(i,a)*s.MN;return n=n>=90||n<=-90?n+180:n,n},g=(t,e=n.M.IMPERIAL)=>{let i='0"';switch(e){case n.M.IMPERIAL:const{feet:e,inches:a}=(0,o.XJ)(t);i=e>0?`${e}' ${a}"`:`${a}"`;break;case n.M.METRIC:i=`${t.toFixed(2)}m`}return i},p=(t,e=10,i=40)=>({width:Math.max(9*Math.max(t,2)+e,i),height:18+e})},22569:(t,e,i)=>{"use strict";i.r(e),i.d(e,{SearchModeToggleCommand:()=>h.X,SendQueryCommand:()=>h.H,default:()=>v});var a,s=i(47724),n=i(40698),r=i(74371),o=i(38003),h=i(62644),c=i(4141);!function(t){t[t.Instant=0]="Instant",t[t.FadeToBlack=1]="FadeToBlack",t[t.Interpolate=2]="Interpolate"}(a||(a={}));var d=i(13469),l=i(29422),m=i(2212),u=i(92532),g=i(79553),p=i(14624),w=i(60225);class MattertagSearchResultItem{constructor(t,e){this.mattertag=t,this.engine=e,this.id=this.mattertag.sid,this.title=this.mattertag.label,this.description=this.mattertag.description,this.type=c.B.MATTERTAG,this.floorId=this.mattertag.floorId,this.onSelect=()=>{this.engine.commandBinder.issueCommand(new w.Y(this.mattertag.sid,a.Interpolate))}}get color(){const t=this.mattertag.color;return`rgb(${255*t.r}, ${255*t.g}, ${255*t.b})`}}class LabelSearchResultItem{constructor(t,e){this.label=t,this.engine=e,this.id=this.label.sid,this.title=this.label.text,this.type=c.B.LABEL,this.floorId=this.label.floorId,this.onSelect=()=>{this.engine.commandBinder.issueCommand(new l.Cs(this.label))}}}class MeasurementSearchResultItem{constructor(t,e,i){this.group=t,this.engine=e,this.units=i,this.id=this.group.info.sid,this.title=(0,d.up)(this.group.length,this.units),this.description=this.group.info.text,this.type=c.B.MEASUREMENT,this.floorId=this.group.info.floorId,this.onSelect=async()=>{const t=[];for(const e of this.group)t.push(e);const e=(0,p.V)(t,new m.Vector3);await this.engine.commandBinder.issueCommand(new l.zs({focusPosition:e,transition:a.Interpolate})),this.engine.commandBinder.issueCommand(new u.tT(g.w1.SEARCH,!1)),setTimeout((()=>this.engine.commandBinder.issueCommand(new u.tT(g.w1.MEASUREMENTS,!0))),500)}}}var M=i(24151),S=i(23953),y=i(27326);class SearchManager{constructor(t,e){this.engine=t,this.initialized=!1,this.searchText="",this.initPromise=this.init(e)}async init(t){const e=this.engine.market;return Promise.all([e.waitForData(y.c)]).then((([e])=>{this.floorsViewData=e,t&&this.updateSearchText(t)}))}async activate(){this.initialized||(this.initialized=!0,await this.initPromise),await this.engine.commandBinder.issueCommand(new h.X(!0))}async deactivate(){await this.engine.commandBinder.issueCommand(new h.X(!1))}updateSearchText(t){this.searchText=t}getSearchText(){return this.searchText}}var T=i(33874),D=i(13789),R=i(55305),C=i(8150),f=i(41591),b=i(69617),I=i(86010),P=i(51058),B=i(21479),x=i(89046),A=i(88454);const{TOOLS:E}=D.Z;class SearchModule extends s.Y{constructor(){super(...arguments),this.name="search",this.query="",this.searchResultsData=new b.r,this.activated=!1,this.textParser=new I.v({links:!0}),this.getPlainText=t=>this.textParser.getPlainText(t),this.dataDirty=!1,this.onApplicationChange=async()=>{this.toolsData.getTool(g.w1.SEARCH)||this.registerTool()},this.updateItemList=async()=>{const{dataMap:t,engine:e}=this,i=[];t.mattertagsData.iterate((t=>i.push(new MattertagSearchResultItem(t,e)))),t.labelData.iterate((t=>i.push(new LabelSearchResultItem(t,e))));const a=this.settingsData.tryGetProperty(R.F.UnitType,P.M.METRIC);for(const s of t.measurementModeData.groups())i.push(new MeasurementSearchResultItem(s,e,a));this.itemList=i,this.dataDirty=!1},this.toggleSearchMode=async t=>{t.opened?this.activateTool():this.deactivateTool()},this.search=async t=>{this.dataDirty&&await this.updateItemList();const e=t.query.toLowerCase(),i=this.itemList.filter((t=>{const i=t.title,a=t.description,s=i.toLowerCase().includes(e)||!!a&&this.getPlainText(a).toLowerCase().includes(e);return t.type===c.B.MATTERTAG&&this.pinRenderer.setPinVisible(t.id,s),s}));this.searchResultsData.setResults(i),this.searchResultsData.setQuery(this.query=t.query)}}async init(t,e){let i;this.config=t,this.engine=e,this.config=t,this.registerTool(),await this.updateDataMap(),[this.settingsData,this.toolsData,i,this.appData]=await Promise.all([e.market.waitForData(T.e),e.market.waitForData(M.t),e.getModule(f.default),e.market.waitForData(B.pu)]),this.pinRenderer=i.pinRenderer;const a=()=>this.dataDirty=!0;this.bindings.push(e.commandBinder.addBinding(h.X,this.toggleSearchMode),e.commandBinder.addBinding(h.H,this.search),this.settingsData.onChanged(a),...Object.values(this.dataMap).map((t=>t.onChanged(a))),e.subscribe(C.bS,this.onApplicationChange)),e.market.register(this,b.r,this.searchResultsData),t.urlSearch&&this.engine.commandBinder.issueCommand(new u.tT(g.w1.SEARCH,!0))}registerTool(){const{config:t}=this,e=new S.U({id:g.w1.SEARCH,namePhraseKey:E.SEARCH,drawer:!1,panel:!0,icon:"icon-magnifying-glass",analytic:"search_mode",toolbar:!1,dimmed:!1,enabled:!0,manager:new SearchManager(this.engine,t.urlSearch?decodeURIComponent(t.urlSearch):void 0)});this.engine.commandBinder.issueCommand(new u.MV([e]))}async updateDataMap(){const{engine:t}=this,[e,i,a]=await Promise.all([t.market.waitForData(n.n),t.market.waitForData(r.D),t.market.waitForData(o.X)]);this.dataMap={mattertagsData:e,labelData:i,measurementModeData:a}}activateTool(){this.activated||(this.config.workshop&&(this.appData.application===B.Mx.WORKSHOP&&this.engine.commandBinder.issueCommand(new x.Mn(!1)),this.engine.commandBinder.issueCommand(new A.KW(!1))),this.activated=!0,this.searchResultsData.setQuery(this.query))}deactivateTool(){this.activated&&(this.config.workshop&&(this.appData.application===B.Mx.WORKSHOP&&this.engine.commandBinder.issueCommand(new x.Mn(!0)),this.engine.commandBinder.issueCommand(new A.KW(!0))),this.activated=!1,this.searchResultsData.setQuery(null),this.resetAllVisibility())}resetAllVisibility(){this.itemList.filter((t=>t.type===c.B.MATTERTAG)).forEach((t=>this.pinRenderer.setPinVisible(t.id,!0)))}}const v=SearchModule}}]);